# Use certbot to generate letsencrypt ssl certs. This will also set up a cron
# job that will ensure the certs are kept up-to-date.

- name: install certbot
  apt:
    name:
      - certbot
      - python3-certbot-dns-route53
    state: present

- name: test if certbot has been initialized
  stat:
    path: /etc/letsencrypt/live/{{fqdn}}/fullchain.pem
  register: cert_file

# This command overrides the default server because wildcard certificates may
# only be obtained using version 2 of the ACME protocol.
#
# https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578
- name: intialize certbot
  command: >
    certbot certonly
      --agree-tos
      --non-interactive
      {{ (env == 'production') | ternary('', '--test-cert') }}
      --email {{letsencrypt_email}}
      --server https://acme-v02.api.letsencrypt.org/directory
      --dns-route53
      --dns-route53-propagation-seconds 30
      -d {{fqdn}}
      -d *.{{fqdn}}
      -d not-web-platform-tests.live
      -d *.not-web-platform-tests.live
  when: cert_file.stat.exists == false

- name: Add cron job for cert renewal
  cron:
    name: Certbot automatic renewal.
    job: "/usr/bin/certbot renew --quiet --no-self-upgrade && systemctl restart wpt"
    minute: 0
    hour: 23
